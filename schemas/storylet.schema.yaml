# storylets.schema.yaml
# JSON Schema (Draft 2020-12) expressed in YAML
# Update: adds required `place_id` (foreign key to Places table by convention)

$schema: "https://json-schema.org/draft/2020-12/schema"
$title: "Cozy Game Storylets Schema"
$id: "https://example.com/schemas/storylets.schema.json"
type: object
additionalProperties: false
required:
  - storylets

properties:
  storylets:
    type: array
    minItems: 1
    items:
      $ref: "#/$defs/storylet"

$defs:
  slug_id:
    type: string
    pattern: "^[a-z0-9_]+$"
    description: "Stable, machine-friendly identifier (lowercase snake_case)."

  player_choice:
    type: string
    enum: ["Yes", "No"]

  repeatable:
    type: string
    enum: ["Once", "Limited", "Always"]

  tone:
    type: string
    enum:
      - Calm
      - Tender
      - Cozy
      - Curious
      - Reflective
      - Nostalgic
      - Gentle_Melancholy
      - Playful
      - Absurd
      - Lively
      - Comforting

  state_changes:
    type: object
    additionalProperties: false
    required:
      - set_flags
      - clear_flags
      - inc_stats
      - dec_stats
      - add_items
      - remove_items
    properties:
      set_flags:
        type: array
        items: { $ref: "#/$defs/slug_id" }
        default: []
      clear_flags:
        type: array
        items: { $ref: "#/$defs/slug_id" }
        default: []
      inc_stats:
        type: object
        additionalProperties:
          type: integer
        default: {}
      dec_stats:
        type: object
        additionalProperties:
          type: integer
        default: {}
      add_items:
        type: array
        items: { type: string }
        default: []
      remove_items:
        type: array
        items: { type: string }
        default: []

  dependencies:
    type: object
    additionalProperties: false
    required:
      - requires_storylets
      - blocks_storylets
      - related_storylets
    properties:
      requires_storylets:
        type: array
        items: { $ref: "#/$defs/slug_id" }
        default: []
      blocks_storylets:
        type: array
        items: { $ref: "#/$defs/slug_id" }
        default: []
      related_storylets:
        type: array
        items: { $ref: "#/$defs/slug_id" }
        default: []

  storylet:
    type: object
    additionalProperties: false
    required:
      - storylet_id
      - place_id
      - narrative_purpose
      - trigger_conditions
      - entry_text_summary
      - player_choice
      - outcome_summary
      - state_changes
      - repeatable
      - tone
      - dependencies
    properties:
      storylet_id:
        $ref: "#/$defs/slug_id"
        description: "Unique ID for this storylet."

      place_id:
        $ref: "#/$defs/slug_id"
        description: "Foreign key to Places (Place_ID)."

      narrative_purpose:
        type: string
        minLength: 1
        description: "Why this exists (e.g., reveal, bond, comfort, consequence)."

      trigger_conditions:
        type: string
        minLength: 1
        description: "Human-readable logic for when this becomes available."

      entry_text_summary:
        type: string
        minLength: 1
        maxLength: 240
        description: "1â€“2 sentence summary of what the player encounters."

      player_choice:
        $ref: "#/$defs/player_choice"

      outcome_summary:
        type: string
        minLength: 1
        maxLength: 240
        description: "What changes as a result (narrative + systemic)."

      state_changes:
        $ref: "#/$defs/state_changes"

      repeatable:
        $ref: "#/$defs/repeatable"

      repeat_limit:
        type:
          - integer
          - "null"
        minimum: 1
        default: null
        description: "If repeatable == Limited, max times allowed; otherwise null/omitted."

      tone:
        $ref: "#/$defs/tone"

      dependencies:
        $ref: "#/$defs/dependencies"

    allOf:
      # If repeatable is Limited, require repeat_limit as a positive integer.
      - if:
          properties:
            repeatable:
              const: "Limited"
          required: ["repeatable"]
        then:
          required: ["repeat_limit"]
          properties:
            repeat_limit:
              type: integer
              minimum: 1
        else:
          # If repeatable is Once or Always, repeat_limit must be null or absent.
          properties:
            repeat_limit:
              type: "null"

# -------------------------
# Minimal example instance:
# -------------------------
examples:
  - storylets:
      - storylet_id: tidepools_notice_01
        place_id: beach_tidepools
        narrative_purpose: comfort
        trigger_conditions: "location == beach_tidepools"
        entry_text_summary: "The tide pools are still enough to reflect the sky in small pieces."
        player_choice: "No"
        outcome_summary: "A small, complete moment of noticing."
        state_changes:
          set_flags: ["tidepools_seen"]
          clear_flags: []
          inc_stats: { calm: 1 }
          dec_stats: {}
          add_items: []
          remove_items: []
        repeatable: "Limited"
        repeat_limit: 3
        tone: "Calm"
        dependencies:
          requires_storylets: []
          blocks_storylets: []
          related_storylets: []

# TODO:
# ### 2.0 Decide the v1 Storylet contract (one-time decisions)

# These decisions keep the code simple and testable:

# - **Binding**: v1 storylets are place-bound (use `place_id`, not `zone_id`).
# - **Choices**: every storylet returns **exactly 3** choices.
# - **Determinism**: every generation step accepts an optional `seed`.
# - **Debugability**: every generated storylet includes `debug` metadata (seed + templates + constraint notes).

# ### 2.1 Confirm/adjust `storylet.schema.yaml` for generated storylets

# File: `schemas/storylet.schema.yaml`

# Add (or confirm) support for:

# - a `debug` object (optional) with freeform string fields (seed, template_id, notes)
# - simple `conditions` structure usable by both authored and generated storylets
# - `choices[*].effects` structure compatible with reducer functions

# Acceptance check:

# - a generated storylet can validate without requiring fully authored prose